name: CI
on:
  push:
  workflow_dispatch:

jobs:
    version-check:
        runs-on: 'ubuntu-latest'
        outputs:
            openroad_version: ${{ steps.check.outputs.openroad_version }}
            rls_version: ${{ steps.check.outputs.rls_version }}
        steps:
        - name: fetch-version
          id: check
          run: |
            # Use master branch for development builds
            openroad_version="master"
            
            echo "openroad_version: ${openroad_version}"
            echo "openroad_version=${openroad_version}" >> ${GITHUB_OUTPUT}

            # Create release version with build number
            rls_version="${openroad_version}.${{ github.run_id }}"
            echo "rls_version=${rls_version}" >> ${GITHUB_OUTPUT}

            cat ${GITHUB_OUTPUT}

    build-linux-x86_64:
        runs-on: 'ubuntu-latest'
        needs: version-check
        strategy:
          matrix:
            image: [manylinux_2_34_x86_64]
        steps:
            - uses: actions/checkout@v4
            - name: print
              run: |
                echo "image: ${{ matrix.image }}"
                echo "openroad_version: ${{ needs.version-check.outputs.openroad_version }}"
                echo "rls_version: ${{ needs.version-check.outputs.rls_version }}"
            - name: build
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                BUILD_NUM: ${{ github.run_id }}
                image: ${{ matrix.image }}
                openroad_version: ${{ needs.version-check.outputs.openroad_version }}
              run: >
                docker run --rm
                --volume "$(pwd):/io"
                --env BUILD_NUM
                --env openroad_version
                --env image
                --workdir /io
                quay.io/pypa/${{ matrix.image }}
                /io/scripts/build.sh
            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: "openroad-${{ matrix.image }}"
                path: |
                  release/openroad-${{ matrix.image }}-*.tar.gz
                  release/version.txt
                if-no-files-found: error
                retention-days: 7

    publish:
        runs-on: 'ubuntu-latest'
        needs: 
        - build-linux-x86_64
        - version-check
        permissions:
            contents: write
        steps:
        - name: Download build artifacts
          uses: actions/download-artifact@v4
          with:
            pattern: "openroad-*"
            path: release
            merge-multiple: true

        - name: Get version from build
          id: get_version
          run: |
            rls_version=$(cat release/version.txt)
            echo "rls_version=${rls_version}" >> ${GITHUB_OUTPUT}
            echo "Release version: ${rls_version}"

        - name: Create Release and Upload Assets
          uses: softprops/action-gh-release@v2
          with:
            tag_name: "${{ steps.get_version.outputs.rls_version }}"
            name: "Release ${{ steps.get_version.outputs.rls_version }}"
            body: |
              Build of OpenROAD
              Version: ${{ steps.get_version.outputs.rls_version }}
            prerelease: true
            files: |
              release/**/*.tar.gz
            fail_on_unmatched_files: true
